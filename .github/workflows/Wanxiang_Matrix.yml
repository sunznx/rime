name: Build Wanxiang Matrix APK

on:
  workflow_dispatch:
  #push:
    #tags:
      #- 'v*'

jobs:
  build_apks:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        branch:
          - wanxiang-hanxin-fuzhu
          - wanxiang-wubi-fuzhu
          - wanxiang-flypy-fuzhu
          - wanxiang-moqi-fuzhu
          - wanxiang-tiger-fuzhu
          - wanxiang-zrm-fuzhu
          - wanxiang-shouyou-fuzhu
          - wanxiang-base

    steps:
      - name: Checkout Wanxiang Repo
        uses: actions/checkout@v4
        with:
          path: wanxiang_root

      - name: Checkout Trime Source
        uses: actions/checkout@v4
        with:
          repository: osfans/trime
          submodules: recursive
          fetch-depth: 0
          path: trime_src

      # 1. æ³¨å…¥ä¸»é¢˜ (æ™ºèƒ½æŸ¥æ‰¾æ–‡ä»¶ç‰ˆ)
      - name: Inject Theme (Jianchun)
        env:
          # ã€è‡ªå®šä¹‰è¿‡æ»¤ã€‘
          DELETE_LIST: ".git .github .idea .gitignore README.md *.png preview.jpg"
        run: |
          echo ">>> [Debug] åˆ—å‡ºä»“åº“å‰3å±‚æ–‡ä»¶ (å¸®åŠ©æ’æŸ¥):"
          ls -R wanxiang_root/ | grep ":$" | head -n 20
          
          echo ">>> [Theme] æ¸…ç† Trime shared ç›®å½•..."
          rm -rf trime_src/app/src/main/assets/shared/*
          
          echo ">>> [Theme] æ­£åœ¨æŸ¥æ‰¾åŒ…å« 'ç®€çº¯' çš„ YAML æ–‡ä»¶..."
          TARGET_FILE=$(find wanxiang_root -type f -name "*ç®€çº¯*.yaml" | head -n 1)
          
          if [ -z "$TARGET_FILE" ]; then
            echo "::error::æœªæ‰¾åˆ°æ–‡ä»¶ååŒ…å«'ç®€çº¯'çš„ yaml æ–‡ä»¶ï¼"
            exit 1
          else
            echo "âœ… æ‰¾åˆ°ç›®æ ‡æ–‡ä»¶: $TARGET_FILE"
            THEME_DIR=$(dirname "$TARGET_FILE")
            echo "âœ… å®šä½ä¸»é¢˜æºç›®å½•: $THEME_DIR"
          fi
          
          echo ">>> [Theme] æ­£åœ¨å‡†å¤‡æ–‡ä»¶..."
          mkdir -p temp_theme_clean
          cp -r "$THEME_DIR"/* temp_theme_clean/
          
          # --- æ‰§è¡Œæ¸…ç†å‡½æ•° ---
          cd temp_theme_clean
          echo "æ­£åœ¨åˆ é™¤æ— å…³æ–‡ä»¶: ${{ env.DELETE_LIST }}"
          for pattern in ${{ env.DELETE_LIST }}; do
            rm -rf $pattern || true
          done
          cd ..
          # -------------------

          echo ">>> [Theme] æ³¨å…¥åˆ° Trime..."
          cp -r temp_theme_clean/* trime_src/app/src/main/assets/shared/
          rm -rf temp_theme_clean
          
          echo ">>> [Theme] æ³¨å…¥å®Œæˆï¼Œæ£€æŸ¥ç»“æœï¼š"
          ls -1 trime_src/app/src/main/assets/shared/ | head -n 5

      # 2. æ³¨å…¥æ–¹æ¡ˆ (ä¿®å¤äº† cp æ‰¾ä¸åˆ°ç›®å½•çš„é—®é¢˜)
      - name: Inject Scheme (${{ matrix.branch }})
        env:
          # ã€è‡ªå®šä¹‰è¿‡æ»¤ã€‘
          DELETE_LIST: ".git .github .gitignore *.md version.txt wanxiang_t9.schema.yaml weasel.yaml LICENSE *.png *.jpg unused_folder update_log.txt"
        run: |
          echo ">>> [Scheme] é‡ç½® Trime rime ç›®å½•..."
          rm -rf trime_src/app/src/main/assets/rime
          # ã€å…³é”®ä¿®å¤ã€‘æ‰‹åŠ¨é‡å»ºè¯¥ç›®å½•
          mkdir -p trime_src/app/src/main/assets/rime/
          
          echo ">>> [Scheme] æ‹‰å–åˆ†æ”¯: ${{ matrix.branch }} ..."
          git clone -b ${{ matrix.branch }} --single-branch --depth 1 https://github.com/${{ github.repository }}.git temp_scheme
          
          # --- æ‰§è¡Œæ¸…ç†å‡½æ•° ---
          echo ">>> [Scheme] æ‰§è¡Œè‡ªå®šä¹‰è¿‡æ»¤..."
          cd temp_scheme
          echo "æ­£åœ¨åˆ é™¤: ${{ env.DELETE_LIST }}"
          for pattern in ${{ env.DELETE_LIST }}; do
             rm -rf $pattern || true
          done
          cd ..
          # -------------------
          
          echo ">>> [Scheme] æ³¨å…¥ Trime..."
          cp -r temp_scheme/* trime_src/app/src/main/assets/rime/
          rm -rf temp_scheme
          
          echo ">>> [Scheme] æ³¨å…¥å®Œæˆï¼Œæ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -1 trime_src/app/src/main/assets/rime/ | head -n 5

# ----------------------------------------------------------------
      # ç¼–è¯‘ç¯å¢ƒå‡†å¤‡ (ç»ˆæä¿®å¤ç‰ˆï¼šç‰©ç†åˆ é™¤ NDK 28)
      # ----------------------------------------------------------------
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: 17
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK 25 and Remove NDK 28
        run: |
          echo ">>> 1. å®‰è£… NDK 25.2.9519653 ..."
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "ndk;25.2.9519653" "cmake;3.22.1"
          
          echo ">>> 2. ã€æ ¸å¼¹æ“ä½œã€‘ç‰©ç†åˆ é™¤ç³»ç»Ÿé¢„è£…çš„ NDK 28 ..."
          # è¿™ä¸€æ­¥æ˜¯å…³é”®ï¼åˆ æ‰ NDK 28ï¼Œè®© Gradle åˆ«æ— é€‰æ‹©
          if [ -d "$ANDROID_HOME/ndk/28.0.13004108" ]; then
            sudo rm -rf $ANDROID_HOME/ndk/28.0.13004108
            echo "âœ… å·²åˆ é™¤ NDK 28"
          else
            echo "â„¹ï¸ æœªå‘ç° NDK 28ï¼Œè·³è¿‡"
          fi
          
          echo ">>> 3. éªŒè¯å½“å‰ NDK ç‰ˆæœ¬ ..."
          ls -l $ANDROID_HOME/ndk/

      - name: Setup Keystore
        working-directory: trime_src
        run: |
          echo "${{ secrets.SIGNING_KEY }}" | base64 -d > trime.jks
          cat << EOF > keystore.properties
          storeFile=$(pwd)/trime.jks
          storePassword=${{ secrets.KEY_STORE_PASSWORD }}
          keyAlias=${{ secrets.ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF

# 7. ç¼–è¯‘æ‰“åŒ… (Release) - ã€ä¿®å¤ç‰ˆæœ¬å†²çªç‰ˆã€‘
      - name: Build Release APK
        working-directory: trime_src
        run: |
          echo ">>> 1. å‡†å¤‡ NDK ç¯å¢ƒ..."
          # æŸ¥æ‰¾ NDK 25 è·¯å¾„
          NDK_PATH=$(find $ANDROID_HOME/ndk -maxdepth 1 -name "25*" | head -n 1)
          if [ -z "$NDK_PATH" ]; then
             echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° NDK 25ï¼Œå°è¯•ä½¿ç”¨ç³»ç»Ÿé»˜è®¤..."
          else
             echo "âœ… é”å®š NDK è·¯å¾„: $NDK_PATH"
             # å†™å…¥ local.properties å‘Šè¯‰ Gradle NDK åœ¨å“ª
             echo "ndk.dir=$NDK_PATH" >> local.properties
          fi

          echo ">>> 2. ã€æ ¸å¿ƒä¿®å¤ã€‘ä¿®æ”¹ build.gradle.kts å¼ºåˆ¶ä½¿ç”¨ NDK 25..."
          
          # æ­¥éª¤ A: æ— è®ºåŸæ¥æºç é‡Œå†™çš„ç‰ˆæœ¬æ˜¯å¤šå°‘ï¼Œå…ˆåˆ æ‰é‚£ä¸€è¡Œï¼Œé˜²æ­¢å†²çª
          sed -i '/ndkVersion/d' app/build.gradle.kts
          
          # æ­¥éª¤ B: åœ¨ android { å—çš„å¼€å¤´æ’å…¥æˆ‘ä»¬è¦çš„ç‰ˆæœ¬
          sed -i 's/android {/android { \n    ndkVersion = "25.2.9519653"/' app/build.gradle.kts

          echo ">>> 3. æ³¨å…¥ç‰ˆæœ¬å·ä¿¡æ¯..."
          # æå–å®˜æ–¹ç‰ˆæœ¬å·
          TRIME_VERSION=$(grep -oE "[0-9]+\.[0-9]+\.[0-9]+" CHANGELOG.md | head -n 1)
          if [ -z "$TRIME_VERSION" ]; then TRIME_VERSION="3.3.x"; fi
          
          # è·å– Commit ID
          COMMIT_ID=$(git rev-parse --short HEAD || echo "custom")
          echo "æ•è·ç‰ˆæœ¬: $TRIME_VERSION ($COMMIT_ID)"

          # æ›¿æ¢åŠ¨æ€å˜é‡ (é˜²æ­¢ Git æŠ¥é”™)
          sed -i 's/buildConfigField("String", "BUILDER", .*)/buildConfigField("String", "BUILDER", "\\"GitHub Actions\\"")/g' app/build.gradle.kts
          sed -i 's/buildConfigField("long", "BUILD_TIMESTAMP", .*)/buildConfigField("long", "BUILD_TIMESTAMP", "0L")/g' app/build.gradle.kts
          sed -i 's/buildConfigField("String", "BUILD_COMMIT_HASH", .*)/buildConfigField("String", "BUILD_COMMIT_HASH", "\\"'${COMMIT_ID}'\\"")/g' app/build.gradle.kts
          sed -i 's/buildConfigField("String", "BUILD_GIT_REPO", .*)/buildConfigField("String", "BUILD_GIT_REPO", "\\"Wanxiang\\"")/g' app/build.gradle.kts
          sed -i 's/buildConfigField("String", "BUILD_VERSION_NAME", .*)/buildConfigField("String", "BUILD_VERSION_NAME", "\\"v'${TRIME_VERSION}-${COMMIT_ID}'\\"")/g' app/build.gradle.kts

          # é…ç½® Git å®‰å…¨ç›®å½•
          git config --global --add safe.directory "*"

          echo ">>> 4. å¼€å§‹ç¼–è¯‘..."
          chmod +x gradlew
          ./gradlew :app:assembleRelease --stacktrace
      # 8. é‡å‘½åé€»è¾‘
      - name: Rename APK
        working-directory: trime_src/app/build/outputs/apk/release/
        run: |
          # 1. æ‰¾åˆ°åŸå§‹ç”Ÿæˆçš„ APK
          ORIGINAL_APK=$(ls *arm64-v8a*release*.apk | head -n 1)
          
          # 2. å®šä¹‰æ–°åå­—
          NEW_NAME="trime-${{ matrix.branch }}-armv8.apk"
          
          # 3. æ‰§è¡Œé‡å‘½å
          echo ">>> é‡å‘½åæ“ä½œ: å°† $ORIGINAL_APK æ”¹ä¸º $NEW_NAME"
          mv "$ORIGINAL_APK" "$NEW_NAME"

      # 9. ä¸Šä¼ è·¯å¾„æŒ‡å‘æ–°åå­—
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: APK-${{ matrix.branch }}
          path: trime_src/app/build/outputs/apk/release/trime-${{ matrix.branch }}-armv8.apk

  release_all:
    needs: build_apks
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_apks
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: all_apks/*.apk
          name: Trime ä¸‡è±¡ç‰ˆ ${{ github.ref_name }}
          body: |
            ## ğŸ‰ æ›´æ–°è¯´æ˜
            ä¸‡è±¡è¾“å…¥æ³•è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ã€‚
            
            ### åŒ…å«åˆ†æ”¯ï¼š
            - æ‰€æœ‰ä¸‡è±¡å˜ä½“ (Hanxin, Wubi, Flypy, Moqi, Tiger, ZRM, Shouyou, Base)
            
            ### ç‰¹æ€§ï¼š
            - é›†æˆâ€œç®€çº¯â€ä¸»é¢˜
            - è·Ÿéšæ¯å¤œåŒæ–‡
            - Release ç­¾å (Arm64-v8a)
          draft: false
          prerelease: false