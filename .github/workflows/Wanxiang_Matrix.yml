name: Build Wanxiang Matrix APK

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build_apks:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        branch:
          - wanxiang-hanxin-fuzhu
          - wanxiang-wubi-fuzhu
          - wanxiang-flypy-fuzhu
          - wanxiang-moqi-fuzhu
          - wanxiang-tiger-fuzhu
          - wanxiang-zrm-fuzhu
          - wanxiang-shouyou-fuzhu
          - wanxiang-base

    steps:
      - name: Checkout Wanxiang Repo
        uses: actions/checkout@v4
        with:
          path: wanxiang_root

      - name: Checkout Trime Source
        uses: actions/checkout@v4
        with:
          repository: osfans/trime
          submodules: recursive
          fetch-depth: 0
          path: trime_src

      - name: Download Shared Gram Model
        run: |
          mkdir -p "$GITHUB_WORKSPACE/common_assets"
          curl -L "https://github.com/amzxyz/RIME-LMDG/releases/download/LTS/wanxiang-lts-zh-hans.gram" \
               -o "$GITHUB_WORKSPACE/common_assets/wanxiang-lts-zh-hans.gram"


      # 2. æ³¨å…¥æ–¹æ¡ˆ (ç»ˆæç‰ˆï¼šå—çº§æ›¿æ¢Schema + é˜²é—ªé€€ + ç¨³å¥æ³¨å…¥)
      - name: Inject Scheme & Smart Sync
        env:
          # åƒåœ¾æ–‡ä»¶è¿‡æ»¤
          DELETE_LIST: ".git .github .gitignore *.md plum weasel.yaml version.txt wanxiang_t9.schema.yaml LICENSE *.png *.jpg unused_folder update_log.txt"
        run: |
          # === 0. å‡†å¤‡å·¥ä½œ ===
          sudo apt-get update && sudo apt-get install -y opencc
          
          RIME_DEST="$GITHUB_WORKSPACE/trime_src/app/src/main/assets/rime"
          SHARED_DEST="$GITHUB_WORKSPACE/trime_src/app/src/main/assets/shared"
          SCRIPT_PATH="$GITHUB_WORKSPACE/wanxiang_root/.github/workflows/scripts/openccset.py"
          DM_PATH="$GITHUB_WORKSPACE/trime_src/app/src/main/java/com/osfans/trime/data/base/DataManager.kt"
          
          # === 1. æ¸…ç†ç›®å½• ===
          rm -rf "$RIME_DEST" "$SHARED_DEST"
          mkdir -p "$RIME_DEST" "$SHARED_DEST"
          
          # === 2. æ‹‰å–æ–¹æ¡ˆ ===
          git clone -b ${{ matrix.branch }} --single-branch --depth 1 https://github.com/${{ github.repository }}.git temp_scheme
          
          # === 3. OpenCC é¢„å¤„ç† ===
          if [ -d "temp_scheme/opencc" ]; then
            python3 "$SCRIPT_PATH" "$GITHUB_WORKSPACE/temp_scheme/opencc"
          fi
          
          # === 4. æ¸…ç†åƒåœ¾ ===
          cd temp_scheme
          for pattern in ${{ env.DELETE_LIST }}; do rm -rf $pattern || true; done
          cd ..
          
          # === 5. èµ„æºåˆ†é… ===
          # 5.1 æ–¹æ¡ˆé…ç½® -> Shared
          cp -rf temp_scheme/* "$SHARED_DEST"/
          rm -rf temp_scheme
          
          # 5.2 ç‰©ç†å¤åˆ¶ç´ æ -> Shared
          if [ -d "wanxiang_root/fonts" ]; then cp -rf "wanxiang_root/fonts" "$SHARED_DEST/"; fi
          if [ -d "wanxiang_root/backgrounds" ]; then cp -rf "wanxiang_root/backgrounds" "$SHARED_DEST/"; fi

          # 5.3 Gram æ¨¡å‹
          cp -f "$GITHUB_WORKSPACE/common_assets/wanxiang-lts-zh-hans.gram" "$SHARED_DEST/wanxiang-lts-zh-hans.gram"
          
          # 5.4 é”å®šé»˜è®¤ä¸»é¢˜
          cd "$SHARED_DEST"
          THEME_FILE=$(find . -maxdepth 1 -name "*ç®€çº¯*.yaml" | head -n 1)
          if [ -n "$THEME_FILE" ]; then
             echo "ğŸ¨ é”å®šé»˜è®¤ä¸»é¢˜: $THEME_FILE"
             mv -f "$THEME_FILE" "trime.yaml"
          fi
          
          # 5.5 æ·±åº¦æ¸…ç†
          if [ -d "custom" ]; then rm -rf custom/*.jpg custom/*.png custom/*.md 2>/dev/null || true; fi
          if [ -d "opencc" ]; then rm -rf opencc/*.txt 2>/dev/null || true; fi
          if [ -d "dicts" ]; then rm -rf dicts/wuzhong.dict.yaml 2>/dev/null || true; fi
          
          # =======================================================
          # === [æ ¸å¿ƒé€»è¾‘] DataManager.kt æºç æ³¨å…¥ ===
          # =======================================================
          echo ">>> [Source] æ­£åœ¨ä¿®æ”¹ DataManager.kt ..."
          if [ -f "$DM_PATH" ]; then
            
            # (1) ä¿®æ”¹é»˜è®¤ç›®å½•åä¸º wanxiang
            sed -i 's/File(Environment.getExternalStorageDirectory(), "rime")/File(Environment.getExternalStorageDirectory(), "wanxiang")/g' "$DM_PATH"

            # -----------------------------------------------------------
            # (2) æ³¨å…¥ Schema List (ä½¿ç”¨å—æ›¿æ¢ï¼Œå½»åº•è§£å†³"è¿˜æ˜¯ä¸¤ä¸ª"çš„é—®é¢˜)
            # -----------------------------------------------------------
            if [[ "${{ matrix.branch }}" == "wanxiang-base" ]]; then
              export TARGET_SCHEMA="wanxiang"
            else
              export TARGET_SCHEMA="wanxiang_pro"
            fi
            
            echo ">>> [Source] æ›¿æ¢ Schema åˆ—è¡¨ (Target: $TARGET_SCHEMA)..."
            
            # è§£é‡Šï¼š
            # (\n\s+)  -> æ•è·ç¬¬ä¸€è¡Œå‰é¢çš„æ¢è¡Œç¬¦å’Œç¼©è¿›ç©ºæ ¼ (å­˜å…¥ $1)
            # - schema: luna_pinyin -> åŒ¹é…ç¬¬ä¸€è¡Œå†…å®¹
            # \n\s+    -> åŒ¹é…ä¸­é—´çš„æ¢è¡Œå’Œç¼©è¿›
            # - schema: luna_pinyin_simp -> åŒ¹é…ç¬¬äºŒè¡Œå†…å®¹
            # 
            # æ›¿æ¢ç»“æœï¼š$1 (åŸæ¥çš„æ¢è¡Œå’Œç¼©è¿›) + "- schema: " + ç›®æ ‡æ–¹æ¡ˆ
            # æ•ˆæœï¼šä¸¤è¡Œå˜ä¸€è¡Œï¼Œä¸”ç¼©è¿›å®Œç¾ç»§æ‰¿ï¼Œä¸ç”¨æ‹…å¿ƒæ ¼å¼ä¹±æ‰ã€‚
            
            perl -i -0777 -pe 's/(\n\s+)- schema: luna_pinyin\n\s+- schema: luna_pinyin_simp/$1- schema: $ENV{TARGET_SCHEMA}/g' "$DM_PATH"

            # -----------------------------------------------------------
            # (3) ã€å¼ºåŠ›æ³¨å…¥ã€‘æ³¨å…¥é˜²é—ªé€€åŒæ­¥ä»£ç 
            # -----------------------------------------------------------
            echo ">>> [Source] æ³¨å…¥é˜²é—ªé€€åŒæ­¥ä»£ç ..."
            
            # é¡ºåºï¼šFonts -> Backgrounds -> trime.yaml
            export INJECT_CODE='
            try {
                val am = appContext.assets
                
                // 1. Fonts
                val fd = java.io.File(userDataDir, "fonts").apply { mkdirs() }
                am.list("shared/fonts")?.forEach { try { ResourceUtils.copyFile("shared/fonts/$it", java.io.File(fd, it).absolutePath) } catch(e:Exception){} }
                
                // 2. Backgrounds
                val bd = java.io.File(userDataDir, "backgrounds").apply { mkdirs() }
                am.list("shared/backgrounds")?.forEach { try { ResourceUtils.copyFile("shared/backgrounds/$it", java.io.File(bd, it).absolutePath) } catch(e:Exception){} }
            } catch(e: Exception) { Timber.e(e, "Assets inject error") }
            Timber.d("Synced!")'

            # æ³¨å…¥
            perl -i -pe 's/Timber.d\("Synced!"\)/$ENV{INJECT_CODE}/' "$DM_PATH"
            
            echo "âœ… DataManager.kt æºç  Patch å®Œæˆ"
          fi
          
          echo ">>> [Check] æœ€ç»ˆçŠ¶æ€æ£€æŸ¥:"
          ls -1 "$SHARED_DEST"
      # ç¼–è¯‘ç¯å¢ƒå‡†å¤‡ (åˆ é™¤ NDK 28)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: 17
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK 25 and Remove NDK 28
        run: |
          echo ">>> 1. å®‰è£… NDK 25.2.9519653 ..."
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "ndk;25.2.9519653" "cmake;3.22.1"
          
          echo ">>> 2. ã€æ ¸å¼¹æ“ä½œã€‘ç‰©ç†åˆ é™¤ç³»ç»Ÿé¢„è£…çš„ NDK 28 ..."
          if [ -d "$ANDROID_HOME/ndk/28.0.13004108" ]; then
            sudo rm -rf $ANDROID_HOME/ndk/28.0.13004108
            echo "âœ… å·²åˆ é™¤ NDK 28"
          else
            echo "â„¹ï¸ æœªå‘ç° NDK 28ï¼Œè·³è¿‡"
          fi
          
          echo ">>> 3. éªŒè¯å½“å‰ NDK ç‰ˆæœ¬ ..."
          ls -l $ANDROID_HOME/ndk/

      - name: Setup Keystore
        working-directory: trime_src
        run: |
          echo "${{ secrets.SIGNING_KEY }}" | base64 -d > trime.jks
          cat << EOF > keystore.properties
          storeFile=$(pwd)/trime.jks
          storePassword=${{ secrets.KEY_STORE_PASSWORD }}
          keyAlias=${{ secrets.ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF

      # 7. ç¼–è¯‘æ‰“åŒ… (ä¿®æ”¹åŒ…å + é”å®šNDK + æ³¨å…¥ç‰ˆæœ¬)
      - name: Build Release APK
        working-directory: trime_src
        run: |

          echo ">>> 2. å‡†å¤‡ NDK ç¯å¢ƒ..."
          NDK_PATH=$(find $ANDROID_HOME/ndk -maxdepth 1 -name "25*" | head -n 1)
          if [ -z "$NDK_PATH" ]; then
             echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° NDK 25"
          else
             echo "ndk.dir=$NDK_PATH" >> local.properties
          fi

          echo ">>> 3. ä¿®æ”¹ Gradle è„šæœ¬..."
          
          # --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¿®æ”¹åŒ…å (Application ID) ---
          echo ">>> æ­£åœ¨ä¿®æ”¹åŒ…åä¸º amzxyz.wanxiang.trime ..."
          sed -i 's/applicationId = "com.osfans.trime"/applicationId = "amzxyz.wanxiang.trime"/g' app/build.gradle.kts
          
          # é”å®š NDK ç‰ˆæœ¬
          sed -i '/ndkVersion/d' app/build.gradle.kts
          sed -i 's/android {/android { \n    ndkVersion = "25.2.9519653"/' app/build.gradle.kts

          echo ">>> 4. æ³¨å…¥ç‰ˆæœ¬å·ä¿¡æ¯..."
          TRIME_VERSION=$(grep -oE "[0-9]+\.[0-9]+\.[0-9]+" CHANGELOG.md | head -n 1)
          if [ -z "$TRIME_VERSION" ]; then TRIME_VERSION="3.3.x"; fi
          COMMIT_ID=$(git rev-parse --short HEAD || echo "custom")
          
          # æ›¿æ¢ BuildConfig å˜é‡
          sed -i 's/buildConfigField("String", "BUILDER", .*)/buildConfigField("String", "BUILDER", "\\"GitHub Actions\\"")/g' app/build.gradle.kts
          sed -i 's/buildConfigField("long", "BUILD_TIMESTAMP", .*)/buildConfigField("long", "BUILD_TIMESTAMP", "0L")/g' app/build.gradle.kts
          sed -i 's/buildConfigField("String", "BUILD_COMMIT_HASH", .*)/buildConfigField("String", "BUILD_COMMIT_HASH", "\\"'${COMMIT_ID}'\\"")/g' app/build.gradle.kts
          sed -i 's/buildConfigField("String", "BUILD_GIT_REPO", .*)/buildConfigField("String", "BUILD_GIT_REPO", "\\"Wanxiang\\"")/g' app/build.gradle.kts
          sed -i 's/buildConfigField("String", "BUILD_VERSION_NAME", .*)/buildConfigField("String", "BUILD_VERSION_NAME", "\\"v'${TRIME_VERSION}-${COMMIT_ID}'\\"")/g' app/build.gradle.kts

          # é…ç½® Git å®‰å…¨ç›®å½•
          git config --global --add safe.directory "*"

          echo ">>> 5. å¼€å§‹ç¼–è¯‘..."
          chmod +x gradlew
          ./gradlew :app:assembleRelease --stacktrace

      # 8. é‡å‘½åé€»è¾‘
      - name: Rename APK
        working-directory: trime_src/app/build/outputs/apk/release/
        run: |
          ORIGINAL_APK=$(ls *arm64-v8a*release*.apk | head -n 1)
          NEW_NAME="trime-${{ matrix.branch }}-armv8a.apk"
          echo ">>> é‡å‘½åæ“ä½œ: å°† $ORIGINAL_APK æ”¹ä¸º $NEW_NAME"
          mv "$ORIGINAL_APK" "$NEW_NAME"

      # 9. ä¸Šä¼ è·¯å¾„æŒ‡å‘æ–°åå­—
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: APK-${{ matrix.branch }}
          path: trime_src/app/build/outputs/apk/release/trime-${{ matrix.branch }}-armv8a.apk

  release_all:
      needs: build_apks
      runs-on: ubuntu-latest
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      permissions:
        contents: write
      steps:
        - name: Get current date
          id: date
          run: echo "date=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_OUTPUT

        - name: Download All Artifacts
          uses: actions/download-artifact@v4
          with:
            path: all_apks
            merge-multiple: true

        - name: Delete 'apk' tag and release
          uses: dev-drprasad/delete-tag-and-release@v1.1
          if: github.event_name == 'workflow_dispatch'
          with:
            delete_release: true
            tag_name: apk
            github_token: ${{ secrets.GITHUB_TOKEN }}

        - name: Create GitHub Release
          uses: softprops/action-gh-release@v2
          with:
            files: all_apks/*.apk
            name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'åŒæ–‡ä¸‡è±¡å®‰å“ç‰ˆæœ¬APPä¸‹è½½' }}
            tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'apk' }}
            body: |
              ### ğŸ› ï¸ æ„å»ºä¿¡æ¯
              - **æ„å»ºæ—¶é—´**: ${{ steps.date.outputs.date }}
              - **åŒ…å**: `amzxyz.wanxiang.trime`
              - **ä¸»é¢˜**: é»˜è®¤é›†æˆç®€çº¯ä¸»é¢˜
              - **ç”¨æˆ·ç›®å½•**: `wanxiang`
              ## ğŸ“¢ ç‰ˆæƒä¸å½’å±å£°æ˜
            
              - **è½¯ä»¶å†…æ ¸**ï¼šåŸºäº [Trime (åŒæ–‡)](https://github.com/osfans/trime) ç¼–è¯‘ï¼Œå½’åŸä½œè€…æ‰€æœ‰ã€‚
              - **è¾“å…¥æ–¹æ¡ˆ**ï¼šå½’ [ä¸‡è±¡æ‹¼éŸ³](https://github.com/${{ github.repository }}) æ‰€æœ‰ã€‚
              - **ä½œå“æ€§è´¨**ï¼šå†æ‰“åŒ…é›†æˆç‰ˆã€‚
              ---
              *ç”± GitHub Actions è‡ªåŠ¨æ„å»ºç”Ÿæˆã€‚*
            draft: false
            prerelease: true
