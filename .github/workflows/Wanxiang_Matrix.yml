name: Build Wanxiang Matrix APK

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build_apks:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        branch:
          - wanxiang-hanxin-fuzhu
          - wanxiang-wubi-fuzhu
          - wanxiang-flypy-fuzhu
          - wanxiang-moqi-fuzhu
          - wanxiang-tiger-fuzhu
          - wanxiang-zrm-fuzhu
          - wanxiang-shouyou-fuzhu
          - wanxiang-base

    steps:
      - name: Checkout Wanxiang Repo
        uses: actions/checkout@v4
        with:
          path: wanxiang_root

      - name: Checkout Trime Source
        uses: actions/checkout@v4
        with:
          repository: osfans/trime
          submodules: recursive
          fetch-depth: 0
          path: trime_src

      - name: Download Shared Gram Model
        run: |
          mkdir -p "$GITHUB_WORKSPACE/common_assets"
          curl -L "https://github.com/amzxyz/RIME-LMDG/releases/download/LTS/wanxiang-lts-zh-hans.gram" \
               -o "$GITHUB_WORKSPACE/common_assets/wanxiang-lts-zh-hans.gram"


      # 2. æ³¨å…¥æ–¹æ¡ˆ (ç»ˆæç‰ˆï¼šå—çº§æ›¿æ¢Schema + é˜²é—ªé€€ + ç¨³å¥æ³¨å…¥)
      - name: Inject Scheme & Smart Sync
        env:
          # åƒåœ¾æ–‡ä»¶è¿‡æ»¤
          DELETE_LIST: ".git .github .gitignore *.md plum weasel.yaml version.txt wanxiang_t9.schema.yaml LICENSE *.png *.jpg unused_folder update_log.txt"
        run: |
          sudo apt-get update && sudo apt-get install -y opencc
          REPO_ROOT="$GITHUB_WORKSPACE/wanxiang_root"
          RIME_DEST="$GITHUB_WORKSPACE/trime_src/app/src/main/assets/rime"
          SHARED_DEST="$GITHUB_WORKSPACE/trime_src/app/src/main/assets/shared"
          SCRIPT_PATH="$GITHUB_WORKSPACE/wanxiang_root/.github/workflows/scripts/openccset.py"
          DM_PATH="$GITHUB_WORKSPACE/trime_src/app/src/main/java/com/osfans/trime/data/base/DataManager.kt"
          
          # æ¸…ç†ç›®å½•
          rm -rf "$RIME_DEST" "$SHARED_DEST"
          mkdir -p "$RIME_DEST" "$SHARED_DEST"
          
          # æ‹‰å–æ–¹æ¡ˆ
          git clone -b ${{ matrix.branch }} --single-branch --depth 1 https://github.com/${{ github.repository }}.git temp_scheme
          
          # OpenCC é¢„å¤„ç†
          if [ -d "temp_scheme/opencc" ]; then
            python3 "$SCRIPT_PATH" "$GITHUB_WORKSPACE/temp_scheme/opencc"
          fi
          # ä»ä¸»ä»“åº“(wanxiang_root)çš„ custom ç›®å½•æ‹¿ zipï¼Œè§£å‹åˆ° temp_scheme
          if [ -f "$REPO_ROOT/custom/ç®€çº¯.zip" ]; then
              echo ">>> ğŸ“¦ å‘ç°ä¸»é¢˜åŒ…ï¼Œæ­£åœ¨è§£å‹åˆ° temp_scheme..."
              unzip -o "$REPO_ROOT/custom/ç®€çº¯.zip" -d temp_scheme/
          fi
          cd temp_scheme
          if [ -f "ç®€çº¯+.trime.yaml" ]; then
              echo ">>> ğŸ¨ é‡å‘½å ç®€çº¯+.trime.yaml -> trime.yaml"
              mv -f "ç®€çº¯+.trime.yaml" "trime.yaml"
          fi
          for pattern in ${{ env.DELETE_LIST }}; do rm -rf $pattern || true; done
          cd ..
          # 5.1 æ–¹æ¡ˆé…ç½® -> Shared
          cp -rf temp_scheme/. "$SHARED_DEST"/
          rm -rf temp_scheme

          # Gram æ¨¡å‹
          if [ -f "$GITHUB_WORKSPACE/common_assets/wanxiang-lts-zh-hans.gram" ]; then
              cp -f "$GITHUB_WORKSPACE/common_assets/wanxiang-lts-zh-hans.gram" "$SHARED_DEST/wanxiang-lts-zh-hans.gram"
          fi
          echo ">>> ğŸ§¹ æ‰§è¡Œæ·±åº¦æ¸…ç†..."
          # æ¸…ç† opencc é‡Œçš„ txt æºæ–‡ä»¶ (åªç•™ ocd2)
          find "$SHARED_DEST/opencc" -name "*.txt" -delete 2>/dev/null || true
          # æ¸…ç†ä¸éœ€è¦çš„è¯åº“
          rm -f "$SHARED_DEST/dicts/wuzhong.dict.yaml" 2>/dev/null || true
          # æ¸…ç†å¤šä½™çš„å›¾ç‰‡ (å¦‚æœä½ æƒ³æ¸…ç†æ ¹ç›®å½•çš„)
          rm -f "$SHARED_DEST/"*.jpg "$SHARED_DEST/"*.png 2>/dev/null || true
          # DataManager.kt æºç æ³¨å…¥
          echo ">>> [Source] æ­£åœ¨ä¿®æ”¹ DataManager.kt ..."
          if [ -f "$DM_PATH" ]; then
            
            # (1) ä¿®æ”¹é»˜è®¤ç›®å½•åä¸º wanxiang
            sed -i 's/File(Environment.getExternalStorageDirectory(), "rime")/File(Environment.getExternalStorageDirectory(), "wanxiang")/g' "$DM_PATH"
            # (2) æ³¨å…¥ Schema List
            if [[ "${{ matrix.branch }}" == "wanxiang-base" ]]; then
              export TARGET_SCHEMA="wanxiang"
            else
              export TARGET_SCHEMA="wanxiang_pro"
            fi
            echo ">>> [Source] æ›¿æ¢ Schema åˆ—è¡¨ (Target: $TARGET_SCHEMA)..."
            perl -i -0777 -pe 's/(\n\s+)- schema: luna_pinyin\n\s+- schema: luna_pinyin_simp/$1- schema: $ENV{TARGET_SCHEMA}/g' "$DM_PATH"

            # é¡ºåºï¼šFonts -> Backgrounds -> trime.yaml
            export INJECT_CODE='
            try {
                val am = appContext.assets
                
                // 1. Fonts
                val fd = java.io.File(userDataDir, "fonts").apply { mkdirs() }
                am.list("shared/fonts")?.forEach { try { ResourceUtils.copyFile("shared/fonts/$it", java.io.File(fd, it).absolutePath) } catch(e:Exception){} }
                
                // 2. Backgrounds
                val bd = java.io.File(userDataDir, "backgrounds").apply { mkdirs() }
                val nomedia = java.io.File(bd, ".nomedia")
                if (!nomedia.exists()) { nomedia.createNewFile() }
                am.list("shared/backgrounds")?.forEach { try { ResourceUtils.copyFile("shared/backgrounds/$it", java.io.File(bd, it).absolutePath) } catch(e:Exception){} }
            } catch(e: Exception) { Timber.e(e, "Assets inject error") }
            Timber.d("Synced!")'

            # æ³¨å…¥
            perl -i -pe 's/Timber.d\("Synced!"\)/$ENV{INJECT_CODE}/' "$DM_PATH"
            
            echo "âœ… DataManager.kt æºç  Patch å®Œæˆ"
          fi
          
          echo ">>> [Check] æœ€ç»ˆçŠ¶æ€æ£€æŸ¥:"
          ls -1 "$SHARED_DEST"
      # ç¼–è¯‘ç¯å¢ƒå‡†å¤‡ (åˆ é™¤ NDK 28)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: 17
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK 25 and Remove NDK 28
        run: |
          echo ">>> 1. å®‰è£… NDK 25.2.9519653 ..."
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "ndk;25.2.9519653" "cmake;3.22.1"
          
          echo ">>> 2. ã€æ ¸å¼¹æ“ä½œã€‘ç‰©ç†åˆ é™¤ç³»ç»Ÿé¢„è£…çš„ NDK 28 ..."
          if [ -d "$ANDROID_HOME/ndk/28.0.13004108" ]; then
            sudo rm -rf $ANDROID_HOME/ndk/28.0.13004108
            echo "âœ… å·²åˆ é™¤ NDK 28"
          else
            echo "â„¹ï¸ æœªå‘ç° NDK 28ï¼Œè·³è¿‡"
          fi
          
          echo ">>> 3. éªŒè¯å½“å‰ NDK ç‰ˆæœ¬ ..."
          ls -l $ANDROID_HOME/ndk/

      - name: Setup Keystore
        working-directory: trime_src
        run: |
          echo "${{ secrets.SIGNING_KEY }}" | base64 -d > trime.jks
          cat << EOF > keystore.properties
          storeFile=$(pwd)/trime.jks
          storePassword=${{ secrets.KEY_STORE_PASSWORD }}
          keyAlias=${{ secrets.ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF

      # 7. ç¼–è¯‘æ‰“åŒ… (ä¿®æ”¹åŒ…å + é”å®šNDK + æ³¨å…¥ç‰ˆæœ¬)
      - name: Build Release APK
        working-directory: trime_src
        run: |

          echo ">>> 2. å‡†å¤‡ NDK ç¯å¢ƒ..."
          NDK_PATH=$(find $ANDROID_HOME/ndk -maxdepth 1 -name "25*" | head -n 1)
          if [ -z "$NDK_PATH" ]; then
             echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° NDK 25"
          else
             echo "ndk.dir=$NDK_PATH" >> local.properties
          fi

          echo ">>> 3. ä¿®æ”¹ Gradle è„šæœ¬..."
          
          # --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä¿®æ”¹åŒ…å (Application ID) ---
          echo ">>> æ­£åœ¨ä¿®æ”¹åŒ…åä¸º amzxyz.wanxiang.trime ..."
          sed -i 's/applicationId = "com.osfans.trime"/applicationId = "amzxyz.wanxiang.trime"/g' app/build.gradle.kts
          
          # é”å®š NDK ç‰ˆæœ¬
          sed -i '/ndkVersion/d' app/build.gradle.kts
          sed -i 's/android {/android { \n    ndkVersion = "25.2.9519653"/' app/build.gradle.kts

          echo ">>> 4. æ³¨å…¥ç‰ˆæœ¬å·ä¿¡æ¯..."
          TRIME_VERSION=$(grep -oE "[0-9]+\.[0-9]+\.[0-9]+" CHANGELOG.md | head -n 1)
          if [ -z "$TRIME_VERSION" ]; then TRIME_VERSION="3.3.x"; fi
          COMMIT_ID=$(git rev-parse --short HEAD || echo "custom")
          
          # æ›¿æ¢ BuildConfig å˜é‡
          sed -i 's/buildConfigField("String", "BUILDER", .*)/buildConfigField("String", "BUILDER", "\\"GitHub Actions\\"")/g' app/build.gradle.kts
          sed -i 's/buildConfigField("long", "BUILD_TIMESTAMP", .*)/buildConfigField("long", "BUILD_TIMESTAMP", "0L")/g' app/build.gradle.kts
          sed -i 's/buildConfigField("String", "BUILD_COMMIT_HASH", .*)/buildConfigField("String", "BUILD_COMMIT_HASH", "\\"'${COMMIT_ID}'\\"")/g' app/build.gradle.kts
          sed -i 's/buildConfigField("String", "BUILD_GIT_REPO", .*)/buildConfigField("String", "BUILD_GIT_REPO", "\\"Wanxiang\\"")/g' app/build.gradle.kts
          sed -i 's/buildConfigField("String", "BUILD_VERSION_NAME", .*)/buildConfigField("String", "BUILD_VERSION_NAME", "\\"v'${TRIME_VERSION}-${COMMIT_ID}'\\"")/g' app/build.gradle.kts

          # é…ç½® Git å®‰å…¨ç›®å½•
          git config --global --add safe.directory "*"

          echo ">>> 5. å¼€å§‹ç¼–è¯‘..."
          chmod +x gradlew
          ./gradlew :app:assembleRelease --stacktrace

      # 8. é‡å‘½åé€»è¾‘
      - name: Rename APK
        working-directory: trime_src/app/build/outputs/apk/release/
        run: |
          ORIGINAL_APK=$(ls *arm64-v8a*release*.apk | head -n 1)
          NEW_NAME="trime-${{ matrix.branch }}-armv8a.apk"
          echo ">>> é‡å‘½åæ“ä½œ: å°† $ORIGINAL_APK æ”¹ä¸º $NEW_NAME"
          mv "$ORIGINAL_APK" "$NEW_NAME"

      # 9. ä¸Šä¼ è·¯å¾„æŒ‡å‘æ–°åå­—
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: APK-${{ matrix.branch }}
          path: trime_src/app/build/outputs/apk/release/trime-${{ matrix.branch }}-armv8a.apk

  release_all:
      needs: build_apks
      runs-on: ubuntu-latest
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      permissions:
        contents: write
      steps:
        - name: Get current date
          id: date
          run: echo "date=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_OUTPUT

        - name: Download All Artifacts
          uses: actions/download-artifact@v4
          with:
            path: all_apks
            merge-multiple: true

        - name: Delete 'apk' tag and release
          uses: dev-drprasad/delete-tag-and-release@v1.1
          if: github.event_name == 'workflow_dispatch'
          with:
            delete_release: true
            tag_name: apk
            github_token: ${{ secrets.GITHUB_TOKEN }}

        - name: Create GitHub Release
          uses: softprops/action-gh-release@v2
          with:
            files: all_apks/*.apk
            name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'åŒæ–‡ä¸‡è±¡å®‰å“ç‰ˆæœ¬APPä¸‹è½½' }}
            tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'apk' }}
            body: |
              ### ğŸ› ï¸ æ„å»ºä¿¡æ¯
              - **æ„å»ºæ—¶é—´**: ${{ steps.date.outputs.date }}
              - **åŒ…å**: `amzxyz.wanxiang.trime`
              - **ä¸»é¢˜**: é»˜è®¤é›†æˆç®€çº¯ä¸»é¢˜
              - **ç”¨æˆ·ç›®å½•**: `wanxiang`
              ## ğŸ“¢ ç‰ˆæƒä¸å½’å±å£°æ˜
            
              - **è½¯ä»¶å†…æ ¸**ï¼šåŸºäº [Trime (åŒæ–‡)](https://github.com/osfans/trime) ç¼–è¯‘ï¼Œå½’åŸä½œè€…æ‰€æœ‰ã€‚
              - **è¾“å…¥æ–¹æ¡ˆ**ï¼šå½’ [ä¸‡è±¡æ‹¼éŸ³](https://github.com/${{ github.repository }}) æ‰€æœ‰ã€‚
              - **ä½œå“æ€§è´¨**ï¼šå†æ‰“åŒ…é›†æˆç‰ˆã€‚
              ---
              *ç”± GitHub Actions è‡ªåŠ¨æ„å»ºç”Ÿæˆã€‚*
            draft: false
            prerelease: true
